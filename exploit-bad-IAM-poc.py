#!/usr/bin/python
import subprocess
import re

def aws():
    print("Checking our IAM access...")
    policies = subprocess.check_output(["aws", "iam", "list-policies"])
    if policies.find("IAMFullAccess"):
        print("... We have full access to IAM!")
        userName = raw_input("Input username: ")
        createUser(userName)
        passwordForUser = raw_input("Create password for user? [y/n]")
        if passwordForUser == "y":
            password = raw_input("Input password for user: ")
            createPassword(userName, password)
        else:
            print("No login profile added for user.")
    else:
        print("... IAM access restricted")

def createUser(user):
    try:
        userCreation = subprocess.check_output(["aws", "iam", "create-user", "--user-name", user])
        print("User created! Trying to find admin groups next...")
        groups = findGroups(user)
    except subprocess.CalledProcessError as e:
        print("EntityAlreadyExists")
        findGroups(user)

def createPassword(user, password):
    try:
        if len(password) > 8:
            addPassword = subprocess.check_output(["aws", "iam", "create-login-profile", "--user-name", user, "--password", password])
            print("Password added succesfully! You should be able to login using the username and password to AWS console.")
        else:
            print("Password needs to be longer. Skipping password addition.")
    except subprocess.CalledProcessError as e:
        print("Unable to set password. Make sure the password conforms with password policy!")

def findGroups(user):
    print("Looking for groups to assign for user...")
    groups = subprocess.check_output(["aws", "iam", "list-groups"]).splitlines()
    for g in groups:
        if "GroupName" in g:
            print("Found group ", g)
            addToGroup = raw_input("Attempt to add user to the group? [y/n]: ")
            if addToGroup == "y":
                extractGroup = re.search(r'"GroupName": "(.*?)"', g).group(1)
                add = subprocess.check_output(["aws", "iam", "add-user-to-group", "--user-name", user, "--group-name", extractGroup])
                print("User added to the group succesfully!\n********")
            else:
                print("User not added to group.\n********")


if __name__ == "__main__":
    aws()
