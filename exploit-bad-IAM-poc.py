#!/usr/bin/python
import subprocess
import re

def aws():
    print("Checking our IAM access...")
    policies = subprocess.check_output(["aws", "iam", "list-policies"])
    if policies.find("IAMFullAccess"):
        print("... We have full access to IAM!")
        userName = raw_input('Input username: ')
        createUser(userName)
    else:
        print("... IAM access restricted")

def createUser(user):
    try:
        userCreation = subprocess.check_output(["aws", "iam", "create-user", "--user-name", user])
        print("User created! Trying to find admin groups next...")
        groups = findGroups(user)
#        print("Found:", groups)
    except subprocess.CalledProcessError as e:
        print("EntityAlreadyExists")
        findGroups(user)

def findGroups(user):
    print("Looking for groups to assign for user...")
    groups = subprocess.check_output(["aws", "iam", "list-groups"]).splitlines()
    for g in groups:
        if "GroupName" in g:
            print("Found group ", g)
            addToGroup = raw_input("Attempt to add user to the group? [y/n]: ")
            if addToGroup == "y":
                extractGroup = re.search(r'"GroupName": "(.*?)"', g).group(1)
                add = subprocess.check_output(["aws", "iam", "add-user-to-group", "--user-name", user, "--group-name", extractGroup])
                print("User added to the group succesfully!\n********")
            else:
                print("User not added to group.\n********")


if __name__ == "__main__":
    aws()
